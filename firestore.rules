rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- User profile from onboarding (owner only) ---
    match /user_profiles/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // ---- Habits (root) ----
    match /user_habits/{habitId} {
      // Read only your own habit doc
      allow read: if request.auth != null
                   && request.auth.uid == resource.data.uid;

      // Create only for yourself; basic shape checks
      allow create: if request.auth != null
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.type is string
                    && request.resource.data.name is string;

      // Update/Delete only your own doc (no UID swaps)
      allow update, delete: if request.auth != null
                            && resource.data.uid == request.auth.uid;

      // ---- Logs subcollection under each habit ----
      match /logs/{logId} {

        // Only the owner of the parent habit can access logs
        function isOwner() {
          return request.auth != null
                 && get(/databases/$(database)/documents/user_habits/$(habitId)).data.uid
                    == request.auth.uid;
        }

        // YYYY-MM-DD format for localDate
        function validDate() {
          return request.resource.data.localDate is string
                 && request.resource.data.localDate.matches('^\\d{4}-\\d{2}-\\d{2}$');
        }

        // Optional timestamp must be a number if present
        function validTs() {
          return !( "ts" in request.resource.data )
                 || request.resource.data.ts is int
                 || request.resource.data.ts is float;
        }

        // Optional meals map: only breakfast/lunch/dinner keys, and allowed values
        function validMeals() {
          return !("meals" in request.resource.data)
                 || (
                      request.resource.data.meals is map
                      && request.resource.data.meals.keys().hasOnly(["breakfast","lunch","dinner"])
                      && (
                           !("breakfast" in request.resource.data.meals)
                           || request.resource.data.meals.breakfast in ["yes","partial","no","skip"]
                         )
                      && (
                           !("lunch" in request.resource.data.meals)
                           || request.resource.data.meals.lunch in ["yes","partial","no","skip"]
                         )
                      && (
                           !("dinner" in request.resource.data.meals)
                           || request.resource.data.meals.dinner in ["yes","partial","no","skip"]
                         )
                    );
        }

        // Only allow these fields on create
        function createHasOnlyAllowedFields() {
          return request.resource.data.keys().hasOnly([ "localDate", "done", "ts", "meals" ]);
        }

        // Only allow these fields to change on update
        function updateChangesAreSafe() {
          return request.resource.data.diff(resource.data).changedKeys()
                   .hasOnly([ "done", "ts", "meals" ]);
        }

        allow read: if isOwner();

        // Create: owner, correct ID/date, valid shape
        allow create: if isOwner()
                      && createHasOnlyAllowedFields()
                      && validDate()
                      && validTs()
                      && validMeals()
                      // Bind document ID to the date string, prevents overwriting other days
                      && request.resource.data.localDate == logId
                      && request.resource.data.done is bool;

        // Update: owner, safe field changes only, keep same localDate & id
        allow update: if isOwner()
                      && updateChangesAreSafe()
                      && validTs()
                      && validMeals()
                      && resource.data.localDate == logId
                      && request.resource.data.localDate == resource.data.localDate;

        // Delete: owner
        allow delete: if isOwner();
      }
    }

    // Add other collections' rules below as neededâ€¦
  }
}
